<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Monitor System</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }
    .container {
      display: flex;
      height: 100vh;
    }
    .webcam-section {
      flex: 2; /* 67% */
      background-color: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    .weather-section {
      flex: 1; /* 33% */
      background-color: #e0f7fa;
      padding: 20px;
      box-sizing: border-box;
    }
    video {
      width: 90%;
      max-width: 640px;
      border: 2px solid #333;
      border-radius: 8px;
    }
    img {
      width: 90%;
      max-width: 640px;
      border: 2px solid #333;
      border-radius: 8px;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      background-color: #2196f3;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #1976d2;
    }
    h2 {
      margin-top: 0;
    }
  </style>
</head>

<body>

<div class="container">
  <!-- Webcam Section -->
  <div class="webcam-section">
    <h2>Live Webcam Monitor</h2>
    <!-- <video id="webcam" src="/video_feed" alt="Webcam Feed" width="640" height="480" autoplay></video>\ -->
    <!-- <img id="live_image" src="../cam_sc/temp.jpg" alt="Live Camera Feed" width="640" height="480"> -->
    <img id="live_image" src="/video_feed" alt="Live Camera Feed">

    <button onclick="toggleWebcam()">Turn On/Off Webcam</button>
    <a id="poseText" style="text-align: center; font-size: 20px; margin-top: 20px;">
      Current Pose: Loading...
    </a>
  </div>
  


  <!-- Weather Section -->
  <div class="weather-section">
    <h2>Weather Information</h2>
    <button onclick="fetchWeather()">Refresh Weather</button>
    <p id="temperature">Temperature: -- °C</p>
    <p id="humidity">Humidity: -- %</p>
    <p id="message">Health Message: --</p>
  </div>
</div>

<script>
// Webcam control
function toggleWebcam() {
    var webcam = document.getElementById('webcam');
    if (webcam.srcObject) {
        webcam.srcObject.getTracks().forEach(track => track.stop());
        webcam.srcObject = null;
    } else {
        // Set the video element's src to the Flask video feed
        webcam.src = "http://localhost:5000/video_feed";
    }
}

// let stream = null;
// function toggleWebcam() {
//     const video = document.getElementById('webcam');
//     if (!stream) {
//         navigator.mediaDevices.getUserMedia({ video: true })
//             .then(s => {
//                 stream = s;
//                 video.srcObject = stream;
//             })
//             .catch(err => console.error("Error accessing webcam: ", err));
//     } else {
//         stream.getTracks().forEach(track => track.stop());
//         video.srcObject = null;
//         stream = null;
//     }
// }

// Fetch weather info
function fetchWeather() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const url = `/weather?lat=${lat}&lon=${lon}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('temperature').innerText = `Temperature: ${data.temperature} °C`;
                    document.getElementById('humidity').innerText = `Humidity: ${data.humidity} %`;
                    document.getElementById('message').innerText = `Health Message: ${data.message}`;
                })
                .catch(error => {
                    console.error('Error fetching weather:', error);
                });
        }, error => {
            console.error('Geolocation error:', error);
        });
    } else {
        alert("Geolocation not supported by this browser.");
    }
}
function fetchPoseStatus() {
    fetch('/pose_status')
        .then(response => response.json())
        .then(data => {
            document.getElementById('poseText').innerText = "Current Pose: " + data.pose;
            if (data.fall) {
                document.body.style.backgroundColor = "#ffe5e5"; // pale red
            } else {
                document.body.style.backgroundColor = "white";  // normal
            }
        })
        .catch(error => console.error('Error fetching pose status:', error));
}

setInterval(() => {
    const img = document.getElementById('live_image');
    img.src = '/video_feed?' + new Date().getTime(); // prevent cache
}, 500);


// Fetch pose every 1s
setInterval(fetchPoseStatus, 1000);

// Auto refresh weather every 30 minutes
setInterval(fetchWeather, 30 * 60 * 1000);

</script>

<script>
window.onload = function() {
    toggleWebcam();
};
</script>

</body>
</html>
